<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>dougiefresh:SearchSentPMs</id>
<version>1.0</version>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.php)                     -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[$context['folder'] = 'inbox';]]></search>
		<add><![CDATA[$context['folder'] = (isset($_REQUEST['search_what']) ? ($_REQUEST['search_what'] == 'inbox' ? 'inbox' : 'sent') : 'inbox');]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[
	if (!empty($foundMessages))]]></search>
		<add><![CDATA[	$context['message_read'] = array();
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></search>
		<add><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			$context['message_read'][$row['id_pm']] = $row['is_read'];
			
			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.template.php)            -->
<!-------------------------------------------------------------------------->
<file name="$themedir/PersonalMessage.template.php">
	<operation>
		<search position="after"><![CDATA[<dt>', $txt['pm_search_order'], ':</dt>]]></search>
		<add><![CDATA[<dt>', $txt['pm_search_what'], ':</dt>
					<dd>
						<select name="search_what">
							<option value="inbox">', $txt['inbox'], '</option>
							<option value="sent">', $txt['sent_items'], '</option>
						</select>
					</dd>
					]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<th class="lefttext last_th" width="20%">', $txt['from'], '</th>]]></search>
		<add><![CDATA[<th class="lefttext last_th" width="20%">', ($context['folder'] == 'inbox' ? $txt['from'] : $txt['to']), '</th>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td>', $message['member']['link'], '</td>]]></search>
		<add><![CDATA[<td>', ($context['folder'] == 'inbox' ? $message['member']['link'] : implode(', ', $message['recipients']['to'])), '</td>]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (Core/PersonalMessage.template.php)       -->
<!-------------------------------------------------------------------------->
<file name="$boarddir/Themes/core/PersonalMessage.template.php" error="skip">
	<operation>
		<search position="after"><![CDATA[<dt>', $txt['pm_search_order'], ':</dt>]]></search>
		<add><![CDATA[<dt>', $txt['pm_search_what'], ':</dt>
					<dd>
						<select name="search_what">
							<option value="inbox">', $txt['inbox'], '</option>
							<option value="sent">', $txt['sent_items'], '</option>
						</select>
					</dd>
					]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td width="20%">', $txt['from'], '</td>]]></search>
		<add><![CDATA[<td width="20%">', ($context['folder'] == 'inbox' ? $txt['from'] : $txt['to']), '</td>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td>', $message['member']['link'], '</td>]]></search>
		<add><![CDATA[<td>', ($context['folder'] == 'inbox' ? $message['member']['link'] : implode(', ', $message['recipients']['to'])), '</td>]]></add>
	</operation>
</file>

</modification>