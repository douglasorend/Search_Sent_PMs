<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>dougiefresh:SearchSentPMs</id>
<version>1.7</version>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.php)                     -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[$context['folder'] = 'inbox';]]></search>
		<add><![CDATA[$context['folder'] = (int) (isset($_REQUEST['search_what']) ? $_REQUEST['search_what'] : 1);
	$context['folder'] = ($context['folder'] == 1 ? 'inbox' : 'sent');]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[
	if (!empty($foundMessages))]]></search>
		<add><![CDATA[	$context['message_read'] = array();
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></search>
		<add><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			$context['message_read'][$row['id_pm']] = $row['is_read'];
			
			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></add>
	</operation>

<!-------------------------------------------------------------------------->
<!-- Search for users in Sent Items and Outbox folders                    -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND ({raw:pm_from_name} LIKE {raw:guest_user_name_implode})))';]]></search>
		<add><![CDATA[// BEGIN: Search users during Sent Item/Outbox searches:
			if ($context['folder'] == 'inbox')
				$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND ({raw:pm_from_name} LIKE {raw:guest_user_name_implode})))';
			else
				$userQuery = 'AND (pmr.id_member IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND ({raw:pm_from_name} LIKE {raw:guest_user_name_implode})))';
			// END: Search users during Sent Item/Outbox searches:]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.template.php)            -->
<!-------------------------------------------------------------------------->
<file name="$themedir/PersonalMessage.template.php">
	<operation>
		<search position="replace"><![CDATA[<th class="lefttext" width="20%">', $txt['from'], '</th>]]></search>
		<add><![CDATA[<th class="lefttext" width="20%">', ($context['folder'] == 'inbox' ? $txt['from'] : $txt['to']), '</th>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td>', $message['member']['link'], '</td>]]></search>
		<add><![CDATA[<td>', ($context['folder'] == 'inbox' ? $message['member']['link'] : implode(', ', $message['recipients']['to'])), '</td>]]></add>
	</operation>

<!-------------------------------------------------------------------------->
<!-- Revisement of Search template to hide unnecessary fields             -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="after"><![CDATA[var oAdvancedPanelToggle = new smc_Toggle({]]></search>
		<add><![CDATA[function hideInboxLabels(current)
			{
				document.getElementById("SearchUserField").innerHTML = current ? "' . $txt['pm_search_to_user'] . ':" : "' . $txt['pm_search_user'] . ':";
				if (current == 0)
					$("#InboxLabelsExpand").slideDown();
				else
					$("#InboxLabelsExpand").slideUp();
			}
			]]></add>
	</operation>		
	<operation>
		<search position="replace"><![CDATA[<dt>', $txt['pm_search_user'], ':</dt>]]></search>
		<add><![CDATA[<dt>', $txt['pm_search_what'], ':</dt>
					<dd>
						<select name="search_what">
							<option value="1" onclick="hideInboxLabels(0); return false;">', $txt['inbox'], '</option>
							<option value="2" onclick="hideInboxLabels(1); return false;">', $txt['sent_items'], '</option>
							<option value="3" onclick="hideInboxLabels(1); return false;">', $txt['unread_items'], '</option>
						</select>
					</dd>
					<dt id="SearchUserField">', $txt['pm_search_user'], ':</dt>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[</dl>';
	if (!$context['currently_using_labels'])
		echo '
				<input type="submit" name="pm_search" value="', $txt['pm_search_go'], '" class="button_submit">';
		echo '
				<br class="clear_right">
			</div>
		</fieldset>';

	// Do we have some labels setup? If so offer to search by them!
	if ($context['currently_using_labels'])
	{
		echo '
		<fieldset class="labels">
			<div class="roundframe">
				<div class="cat_bar">
					<h3 class="catbg">
						<span id="advanced_panel_toggle" class="toggle_up floatright" style="display: none;"></span><a href="#" id="advanced_panel_link">', $txt['pm_search_choose_label'], '</a>
					</h3>
				</div>
				<div id="advanced_panel_div">
					<ul id="searchLabelsExpand" class="reset">';

		foreach ($context['search_labels'] as $label)
			echo '
						<li>
							<label for="searchlabel_', $label['id'], '"><input type="checkbox" id="searchlabel_', $label['id'], '" name="searchlabel[', $label['id'], ']" value="', $label['id'], '"', $label['checked'] ? ' checked' : '', ' class="input_check">
							', $label['name'], '</label>
						</li>';

		echo '
					</ul>
				</div>
				<p>
					<span class="floatleft"><input type="checkbox" name="all" id="check_all" value=""', $context['check_all'] ? ' checked' : '', ' onclick="invertAll(this, this.form, \'searchlabel\');" class="input_check"><em> <label for="check_all">', $txt['check_all'], '</label></em></span>
					<input type="submit" name="pm_search" value="', $txt['pm_search_go'], '" class="button_submit">
				</p>
				<br class="clear_right">
			</div>
		</fieldset>';]]></search>
		<add><![CDATA[</dl>';
		echo '
				<br class="clear_right">
			</div>
		</fieldset>';

	// Do we have some labels setup? If so offer to search by them!
	if ($context['currently_using_labels'])
	{
		echo '
		<div id="InboxLabelsExpand"><fieldset class="labels">
			<div class="roundframe">
				<div class="cat_bar">
					<h3 class="catbg">
						<span id="advanced_panel_toggle" class="toggle_up floatright" style="display: none;"></span><a href="#" id="advanced_panel_link">', $txt['pm_search_choose_label'], '</a>
					</h3>
				</div>
				<div id="advanced_panel_div">
					<ul id="searchLabelsExpand" class="reset">';

		foreach ($context['search_labels'] as $label)
			echo '
						<li>
							<label for="searchlabel_', $label['id'], '"><input type="checkbox" id="searchlabel_', $label['id'], '" name="searchlabel[', $label['id'], ']" value="', $label['id'], '"', $label['checked'] ? ' checked' : '', ' class="input_check">
							', $label['name'], '</label>
						</li>';

		echo '
					</ul>
				</div>
				<p>
					<span class="floatleft"><input type="checkbox" name="all" id="check_all" value=""', $context['check_all'] ? ' checked' : '', ' onclick="invertAll(this, this.form, \'searchlabel\');" class="input_check"><em> <label for="check_all">', $txt['check_all'], '</label></em></span>
				</p>
				<br class="clear_right">
			</div>
		</fieldset></div>
		<br class="clear_right">
		<p><input type="submit" name="pm_search" value="', $txt['pm_search_go'], '" class="button_submit"></p>';]]></add>
	</operation>
</file>
</modification>