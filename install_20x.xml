<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
<id>dougiefresh:SearchSentPMs</id>
<version>1.6</version>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.php)                     -->
<!-------------------------------------------------------------------------->
<file name="$sourcedir/PersonalMessage.php">
	<operation>
		<search position="replace"><![CDATA[$context['folder'] = 'inbox';]]></search>
		<add><![CDATA[$context['folder'] = (int) (isset($_REQUEST['search_what']) ? $_REQUEST['search_what'] : 1);
	$context['folder'] = ($context['folder'] == 1 ? 'inbox' : 'sent');]]></add>
	</operation>
	<operation>
		<search position="after"><![CDATA[
	if (!empty($foundMessages))]]></search>
		<add><![CDATA[	$context['message_read'] = array();
]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></search>
		<add><![CDATA[$recipients[$row['id_pm']][empty($row['bcc']) ? 'to' : 'bcc'][] = empty($row['id_member_to']) ? $txt['guest_title'] : '<a href="' . $scripturl . '?action=profile;u=' . $row['id_member_to'] . '">' . $row['to_name'] . '</a>';

			$context['message_read'][$row['id_pm']] = $row['is_read'];
			
			if ($row['id_member_to'] == $user_info['id'] && $context['folder'] != 'sent')]]></add>
	</operation>

<!-------------------------------------------------------------------------->
<!-- Search for users in Sent Items and Outbox folders                    -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="replace"><![CDATA[$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})))';]]></search>
		<add><![CDATA[// BEGIN: Search users during Sent Item/Outbox searches:
			if ($context['folder'] == 'inbox')
				$userQuery = 'AND (pm.id_member_from IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})))';
			else
				$userQuery = 'AND (pmr.id_member IN ({array_int:member_list}) OR (pm.id_member_from = 0 AND (pm.from_name LIKE {raw:guest_user_name_implode})))';
			// END: Search users during Sent Item/Outbox searches:]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (PersonalMessage.template.php)            -->
<!-------------------------------------------------------------------------->
<file name="$themedir/PersonalMessage.template.php">
	<operation>
		<search position="replace"><![CDATA[<th class="lefttext last_th" width="20%">', $txt['from'], '</th>]]></search>
		<add><![CDATA[<th class="lefttext last_th" width="20%">', ($context['folder'] == 'inbox' ? $txt['from'] : $txt['to']), '</th>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td>', $message['member']['link'], '</td>]]></search>
		<add><![CDATA[<td>', ($context['folder'] == 'inbox' ? $message['member']['link'] : implode(', ', $message['recipients']['to'])), '</td>]]></add>
	</operation>

<!-------------------------------------------------------------------------->
<!-- Revisement of Search template to hide unnecessary fields             -->
<!-------------------------------------------------------------------------->
	<operation>
		<search position="before"><![CDATA[document.getElementById("expandLabelsIcon").src = smf_images_url + (current ? "/expand.gif" : "/collapse.gif");]]></search>
		<add><![CDATA[
		}
		function expandShowLabels(current)
		{
			document.getElementById("SearchUserField").innerHTML = current ? "' . $txt['pm_search_to_user'] . ':" : "' . $txt['pm_search_user'] . ':";
			document.getElementById("InboxLabelsExpand").style.display = current ? "none" : "";]]></add>
	</operation>		
	<operation>
		<search position="replace"><![CDATA[<dt>', $txt['pm_search_user'], ':</dt>]]></search>
		<add><![CDATA[<dt>', $txt['pm_search_what'], ':</dt>
					<dd>
						<select name="search_what">
							<option value="1" onclick="expandShowLabels(0); return false;">', $txt['inbox'], '</option>
							<option value="2" onclick="expandShowLabels(1); return false;">', $txt['sent_items'], '</option>
						</select>
					</dd>
					<dt id="SearchUserField">', $txt['pm_search_user'], ':</dt>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[</dl>';
		if (!$context['currently_using_labels'])
			echo '
				<input type="submit" name="submit" value="', $txt['pm_search_go'], '" class="button_submit floatright" />';
			echo '
				<br class="clear" />
			</div>
			<span class="lowerframe"><span></span></span>
		</fieldset>';

		// Do we have some labels setup? If so offer to search by them!
		elseif ($context['currently_using_labels'])
		{
			echo '
		<fieldset class="labels">
			<span class="upperframe"><span></span></span>
			<div class="roundframe">
				<div class="title_bar">
					<h4 class="titlebg">
						<span class="ie6_header floatleft"><a href="javascript:void(0);" onclick="expandCollapseLabels(); return false;"><img src="', $settings['images_url'], '/expand.gif" id="expandLabelsIcon" alt="" /></a> <a href="javascript:void(0);" onclick="expandCollapseLabels(); return false;"><strong>', $txt['pm_search_choose_label'], '</strong></a></span>
					</h4>
				</div>
				<ul id="searchLabelsExpand" class="reset" ', $context['check_all'] ? 'style="display: none;"' : '', '>';

			foreach ($context['search_labels'] as $label)
				echo '
					<li>
						<label for="searchlabel_', $label['id'], '"><input type="checkbox" id="searchlabel_', $label['id'], '" name="searchlabel[', $label['id'], ']" value="', $label['id'], '" ', $label['checked'] ? 'checked="checked"' : '', ' class="input_check" />
						', $label['name'], '</label>
					</li>';

			echo '
				</ul>
				<p>
					<span class="floatleft"><input type="checkbox" name="all" id="check_all" value="" ', $context['check_all'] ? 'checked="checked"' : '', ' onclick="invertAll(this, this.form, \'searchlabel\');" class="input_check" /><em> <label for="check_all">', $txt['check_all'], '</label></em></span>
					<input type="submit" name="submit" value="', $txt['pm_search_go'], '" class="button_submit floatright" />
				</p><br class="clear" />
			</div>
			<span class="lowerframe"><span></span></span>
		</fieldset>';
		}
	}

	echo ']]></search>
		<add><![CDATA[</dl>
				<br class="clear" />
			</div>
			<span class="lowerframe"><span></span></span>
		</fieldset>';

		// Do we have some labels setup? If so offer to search by them!
		if ($context['currently_using_labels'])
		{
			echo '
		<div id="InboxLabelsExpand"><fieldset class="labels">
			<span class="upperframe"><span></span></span>
			<div class="roundframe">
				<div class="title_bar">
					<h4 class="titlebg">
						<span class="ie6_header floatleft"><a href="javascript:void(0);" onclick="expandCollapseLabels(); return false;"><img src="', $settings['images_url'], '/expand.gif" id="expandLabelsIcon" alt="" /></a> <a href="javascript:void(0);" onclick="expandCollapseLabels(); return false;"><strong>', $txt['pm_search_choose_label'], '</strong></a></span>
					</h4>
				</div>
				<ul id="searchLabelsExpand" class="reset" ', $context['check_all'] ? 'style="display: none;"' : '', '>';

			foreach ($context['search_labels'] as $label)
				echo '
					<li>
						<label for="searchlabel_', $label['id'], '"><input type="checkbox" id="searchlabel_', $label['id'], '" name="searchlabel[', $label['id'], ']" value="', $label['id'], '" ', $label['checked'] ? 'checked="checked"' : '', ' class="input_check" />
						', $label['name'], '</label>
					</li>';

			echo '
				</ul>
				<p>
					<span class="floatleft"><input type="checkbox" name="all" id="check_all" value="" ', $context['check_all'] ? 'checked="checked"' : '', ' onclick="invertAll(this, this.form, \'searchlabel\');" class="input_check" /><em> <label for="check_all">', $txt['check_all'], '</label></em></span>
				</p><br class="clear" />
			</div>
			<span class="lowerframe"><span></span></span>
		</fieldset></div>';
		}
	}

	echo '
		<p><input type="submit" name="submit" value="', $txt['pm_search_go'], '" class="button_submit floatright" /></p>]]></add>
	</operation>
</file>

<!-------------------------------------------------------------------------->
<!-- Search PMs from Sent Items (Core/PersonalMessage.template.php)       -->
<!-------------------------------------------------------------------------->
<file name="$boarddir/Themes/core/PersonalMessage.template.php" error="skip">
	<operation>
		<search position="after"><![CDATA[<dt>', $txt['pm_search_order'], ':</dt>]]></search>
		<add><![CDATA[<dt>', $txt['pm_search_what'], ':</dt>
					<dd>
						<select name="search_what">
							<option value="inbox">', $txt['inbox'], '</option>
							<option value="sent">', $txt['sent_items'], '</option>
						</select>
					</dd>
					]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td width="20%">', $txt['from'], '</td>]]></search>
		<add><![CDATA[<td width="20%">', ($context['folder'] == 'inbox' ? $txt['from'] : $txt['to']), '</td>]]></add>
	</operation>
	<operation>
		<search position="replace"><![CDATA[<td>', $message['member']['link'], '</td>]]></search>
		<add><![CDATA[<td>', ($context['folder'] == 'inbox' ? $message['member']['link'] : implode(', ', $message['recipients']['to'])), '</td>]]></add>
	</operation>
</file>

</modification>